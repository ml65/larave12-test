# Техническое видение проекта

## 1. Технологии

### Backend
- **Laravel 12** — основной фреймворк
- **PHP 8.4** — язык программирования

### База данных
- **MySQL** — реляционная БД для хранения данных

### Библиотеки
- **spatie/laravel-permission** — управление ролями и правами доступа
- **spatie/laravel-medialibrary** — работа с файлами (прикрепление к заявкам)

### Frontend
- **Blade шаблоны** — серверный рендеринг
- **Vanilla JavaScript** — AJAX запросы без фреймворков
- **Простой CSS** — стилизация без дополнительных библиотек

### Инфраструктура
- **Docker + docker-compose** — для локального запуска (опционально)
- **Встроенный PHP сервер** — для разработки (php artisan serve)

### Исключено на старте
- Redis/кеширование — не требуется для MVP
- Nginx/Apache — используем встроенный сервер Laravel
- Frontend фреймворки — только нативный JS
- CSS фреймворки — только чистый CSS

## 2. Принцип разработки

### Основные принципы
- **KISS** — максимальная простота, никакого оверинжиниринга
- **SOLID** — разделение ответственности между классами
- **MVC** — стандартная архитектура Laravel
- **DRY** — избегание дублирования кода
- **PSR-12** — соблюдение стандарта кодирования PHP

### Подход к коду
- Вся бизнес-логика в сервисах и репозиториях
- Контроллеры остаются тонкими (только координация)
- Валидация строго через FormRequest классы
- Строгая типизация: `declare(strict_types=1);`, type hints везде
- Early returns вместо глубокой вложенности if-ов
- Функциональный стиль где возможно

### Тестирование
- Тесты создаются по мере добавления функционала
- Базовое покрытие критичных частей (создание заявок, валидация)

### Git
- Чистая история коммитов
- Каждый этап разработки — отдельный коммит
- Простые и понятные сообщения коммитов

## 3. Структура проекта

### Стандартная структура Laravel
```
app/
├── Models/              # Eloquent модели (User, Customer, Ticket)
├── Http/
│   ├── Controllers/
│   │   ├── Api/        # API контроллеры
│   │   └── Web/        # Web контроллеры (админ-панель)
│   ├── Requests/       # FormRequest классы для валидации
│   └── Resources/      # API Resources для форматирования ответов
├── Services/           # Бизнес-логика (TicketService, CustomerService)
│   └── BaseService.php # Базовый класс сервиса
└── Repositories/       # Работа с данными (TicketRepository, CustomerRepository)
    └── BaseRepository.php # Базовый класс репозитория

database/
├── migrations/         # Миграции БД
├── factories/         # Фабрики для тестовых данных
└── seeders/           # Сидеры с тестовыми данными

routes/
├── api.php            # API маршруты
└── web.php            # Web маршруты (виджет, админ-панель)

resources/
└── views/             # Blade шаблоны
    ├── widget.blade.php
    └── admin/         # Шаблоны админ-панели
```

### Принципы организации
- Разделение API и Web контроллеров по папкам
- Базовые классы (BaseService, BaseRepository) для демонстрации наследования
- Простая структура без лишних абстракций

## 4. Архитектура проекта

### Трёхслойная архитектура

**Слои:**
1. **Контроллеры** (API/Web) — принимают запросы, вызывают сервисы, возвращают ответы
2. **Сервисы** — бизнес-логика (создание заявок, проверка лимитов, изменение статусов)
3. **Репозитории** — работа с БД через модели (CRUD, фильтрация, статистика)

### Поток данных
```
Запрос → Controller → Service → Repository → Model → БД
Ответ ← Controller ← Service ← Repository ← Model ← БД
```

### Валидация
- **FormRequest** — валидация входящих данных перед контроллером
- Дополнительная бизнес-валидация в сервисах при необходимости

### Форматирование ответов
- **API Resources** — для форматирования всех API ответов

### Передача данных
- Передача массивов/объектов напрямую между слоями (без DTO)
- События (Events/Listeners) не используются на старте

## 5. Модель данных

### Сущности и связи

**User** (менеджер/администратор)
- Поля: `id`, `name`, `email`, `password`, `created_at`, `updated_at`
- Роли через `spatie/laravel-permission`

**Customer** (клиент)
- Поля: `id`, `name`, `phone` (E.164 формат), `email`, `created_at`, `updated_at`
- Связь: `hasMany(Ticket)`

**Ticket** (заявка)
- Поля: `id`, `customer_id`, `subject`, `text`, `status` (string: 'new'/'in_progress'/'completed'), `manager_response_date` (nullable), `created_at`, `updated_at`
- Связи: `belongsTo(Customer)`, `hasMany(Media)` через медиа-библиотеку
- Валидация статуса через FormRequest

**Media** (файлы)
- Через `spatie/laravel-medialibrary`
- Привязка к Ticket через полиморфную связь

### Индексы
- Базовые индексы Laravel (primary keys, foreign keys)
- Дополнительные индексы не требуются на старте

## 6. Работа с LLM

**Не используется** — интеграция с LLM не планируется в рамках текущего проекта.

## 7. Мониторинг LLM

**Не используется** — мониторинг LLM не требуется, так как интеграция с LLM не планируется.

## 8. Сценарии работы

### Сценарий 1: Клиент создаёт заявку
1. Клиент открывает виджет через iframe на внешнем сайте
2. Заполняет форму: имя, телефон (E.164), email, тема, текст, прикрепляет файлы
3. Отправка через AJAX на `POST /api/tickets`
4. Валидация данных через FormRequest
5. Проверка лимита (не более 1 заявки в день с одного контакта) в сервисе
6. Создание/поиск Customer через репозиторий
7. Создание Ticket через сервис
8. Сохранение файлов через медиа-библиотеку
9. Возврат успешного ответа через API Resource

### Сценарий 2: Менеджер просматривает заявки
1. Авторизация в админ-панели (только для пользователей с ролью менеджера)
2. Просмотр списка заявок с фильтрацией (дата, статус, email, телефон)
3. Просмотр деталей заявки (включая все прикреплённые файлы со ссылками на скачивание)
4. Изменение статуса заявки через форму

### Сценарий 3: Получение статистики
1. API запрос на `GET /api/tickets/statistics` (только для авторизованных менеджеров)
2. Расчёт статистики через Eloquent scopes и Carbon
3. Возврат статистики (дневная, недельная, месячная) через API Resource

## 9. Деплой

### Разработка
- Локальный запуск через `php artisan serve`
- Docker Compose для быстрого старта окружения (будет добавлен позже, не на старте)

### Продакшен (MVP)
- Простой VPS/хостинг с PHP 8.4 и MySQL
- Ручной деплой: git clone, composer install, миграции, настройка .env
- Встроенный PHP сервер или простой веб-сервер (Nginx/Apache)
- Docker будет использоваться только для стенда (позже)

### Автоматизация
- CI/CD не используется на старте
- Ручной деплой для MVP

## 10. Подход к конфигурированию

### Основной подход
- Стандартный `.env` файл для всех настроек (БД, APP_KEY, APP_URL и т.д.)
- Один `.env` для всех окружений (без разделения на dev/staging/prod)
- `.env.example` как шаблон с примерами всех необходимых переменных
- Конфигурационные файлы в `config/` только при необходимости
- Использование `env()` напрямую в коде только для простых случаев

## 11. Подход к логгированию

### Основной подход
- Стандартное логирование Laravel через `Log` facade
- Стандартные каналы Laravel (single/daily) без дополнительной настройки
- Логирование только ошибок и критичных событий (создание заявок, изменение статусов)
- Без дополнительных сервисов логирования (Sentry, Logstash и т.д.)
- Простое и минималистичное решение для MVP

